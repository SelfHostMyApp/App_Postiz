services:
  postiz:
    image: ghcr.io/gitroomhq/postiz-app:${POSTIZ_VERSION:-latest}
    container_name: postiz
    restart: unless-stopped
    environment:
      - MAIN_URL=https://${POSTIZ_SUBDOMAIN}.${ROOT_DOMAIN}
      - FRONTEND_URL=https://${POSTIZ_SUBDOMAIN}.${ROOT_DOMAIN}
      - NEXT_PUBLIC_BACKEND_URL=https://${POSTIZ_SUBDOMAIN}.${ROOT_DOMAIN}/api
      - JWT_SECRET=${POSTIZ_JWT_SECRET}
      - DATABASE_URL=postgresql://postiz-user:${POSTIZ_PASSWORD}@postiz-postgres:5432/postiz-db-local
      - REDIS_URL=redis://postiz-redis:6379
      - BACKEND_INTERNAL_URL=http://localhost:3000
      - IS_GENERAL=true
      - DISABLE_REGISTRATION=${POSTIZ_DISABLE_REGISTRATION:-false}
      - STORAGE_PROVIDER=local
      - UPLOAD_DIRECTORY=/uploads
      - NEXT_PUBLIC_UPLOAD_DIRECTORY=/uploads
    volumes:
      - postiz-config:/config/
      - postiz-uploads:/uploads/
    ports:
      - ${POSTIZ_PORT:-5000}:5000
    networks:
      - postiz-network
    depends_on:
      postiz-postgres:
        condition: service_healthy
      postiz-redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.postiz.rule=Host(`${POSTIZ_SUBDOMAIN}.${ROOT_DOMAIN}`)"
      - "traefik.http.routers.postiz.entrypoints=websecure"
      - "traefik.http.routers.postiz.middlewares=cloudflare-ipallowlist@file"
      - "traefik.http.routers.postiz.tls.certresolver=cloudflare"
      - "traefik.http.services.postiz.loadbalancer.server.port=5000"
      - "traefik.http.routers.postiz.middlewares=${POSTIZ_AUTH:+postiz-auth}"
      - "traefik.http.middlewares.postiz-auth.basicauth.users=${POSTIZ_AUTH}"

  postiz-postgres:
    image: postgres:17-alpine
    container_name: postiz-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=${POSTIZ_PASSWORD}
      - POSTGRES_USER=postiz-user
      - POSTGRES_DB=postiz-db-local
    volumes:
      - postgres-volume:/var/lib/postgresql/data
    networks:
      - postiz-network
    healthcheck:
      test: pg_isready -U postiz-user -d postiz-db-local
      interval: 10s
      timeout: 3s
      retries: 3

  postiz-redis:
    image: redis:7.2
    container_name: postiz-redis
    restart: unless-stopped
    healthcheck:
      test: redis-cli ping
      interval: 10s
      timeout: 3s
      retries: 3
    volumes:
      - postiz-redis-data:/data
    networks:
      - postiz-network

volumes:
  postiz-config:
    external: false
  postiz-uploads:
    external: false
  postgres-volume:
    external: false
  postiz-redis-data:
    external: false

networks:
  postiz-network:
    external: false
